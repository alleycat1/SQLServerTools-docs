# Обслуживание

Информация об различных аспектах обслуживания SQL Server.

## Служебная база данных

В разделе [Service-Database](Service-Database) содержится описание служебной базы данных для обслуживания и мониторинга, а также примеры работы с этой базой:

* Обслуживание индексов с различными настраиваемыми параметрами.
* Обслуживание объектов статистик с гибкими настройками обслуживания.
* Сбор информации о размерах таблиц баз данных на сервере.

Примеры помогут организовать обслуживание на любой вкус.

## Скрипты

| Имя скрипта | Описание |
| ----------- | -------- |
| [Обслуживание индексов (простой)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%BE%D0%B2%20(%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9).sql) | Обслуживание индексов самым простым способом |
| [Обслуживание индексов (расширенный)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%BE%D0%B2%20(%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9).sql) | Обслуживание индексов с расширенным набором параметров (разрешенное время выполнения, параллелизм и др.) |
| [Обслуживание индексов (расширенный, online-перестроение)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%BE%D0%B2%20(%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%2C%20online-%D0%BF%D0%B5%D1%80%D0%B5%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D0%B5).sql) | Обслуживание индексов с рассширенным набором параметров, а также возможностью запуска online-перестроения |
| [Обслуживание статистики (простой)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20(%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9).sql) | Обслуживание объектов статистики самым простым способом |
| [Обслуживание статистики (расширенный)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20(%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9).sql) | Обслуживание статистики с расширенным набором параметров (разрешенное время выполнения и др.) с самым точным результатом |
| [Обслуживание статистики (расширенный с автоподбором параметров)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20(%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20%D1%81%20%D0%B0%D0%B2%D1%82%D0%BE%D0%BF%D0%BE%D0%B4%D0%B1%D0%BE%D1%80%D0%BE%D0%BC%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%B2).sql) | Обслуживание статистики с расширенным набором параметров и гибким подбором настроек обновления (менее точная статистика, но подходит для большинства случаев) |
| [Очистка процедурного кэша](%D0%9E%D1%87%D0%B8%D1%81%D1%82%D0%BA%D0%B0%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%B4%D1%83%D1%80%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BA%D1%8D%D1%88%D0%B0.sql) | Очистка процедурного кэша. Будьте осторожны. Делать нужно, если понимаете зачем |
| [Информация о сжатых таблицах и индексах](%D0%98%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F%20%D0%BE%20%D1%81%D0%B6%D0%B0%D1%82%D1%8B%D1%85%20%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%D1%85%20%D0%B8%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%B0%D1%85.sql) | Получение общей информации о применении сжатия к объектам базы данных |
| [Сжатие таблиц базы данных](%D0%A1%D0%B6%D0%B0%D1%82%D0%B8%D0%B5%20%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85.sql) | Применение сжатия для всех таблиц и индекосв в базе данных (по умолчанию - PAGE) |
| [Сжатие таблиц базы данных (точечно)](%D0%A1%D0%B6%D0%B0%D1%82%D0%B8%D0%B5%20%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20(%D1%82%D0%BE%D1%87%D0%B5%D1%87%D0%BD%D0%BE).sql) | Применение сжатия для всех таблиц и индекосв в базе данных (по умолчанию - PAGE) точечно по отдельным объектам |
| [Обслуживание индексов для всех баз данных (пример)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%BE%D0%B2%20%D0%B4%D0%BB%D1%8F%20%D0%B2%D1%81%D0%B5%D1%85%20%D0%B1%D0%B0%D0%B7%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20(%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80).sql) | Пример скрипта для запуска обслуживания индексов для всех баз данных |
| [Обслуживание статистик для всех баз данных (пример)](%D0%9E%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%20%D0%B4%D0%BB%D1%8F%20%D0%B2%D1%81%D0%B5%D1%85%20%D0%B1%D0%B0%D0%B7%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20(%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80).sql) | Пример скрипта для запуска обслуживания статистик для всех баз данных |
| [Анализ сжатия объектов базы данных](%D0%98%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F%20%D0%BE%20%D1%81%D0%B6%D0%B0%D1%82%D0%B8%D0%B8%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2%20(heap%2C%20%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%BD%D1%8B%D0%B5%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D1%8B%20%D0%B8%20%D0%B4%D1%80.).sql) | Скрипт для анализа сжатия объектов базы данных (кучи (heap), кластерные индексы, другие объекты) |

## Материалы

* [Базы данных. Несколько шагов до серьезного обслуживания](https://ypermitin.github.io/sqlserver/2022/05/22/Базы-данных.-Несколько-шагов-до-серьезного-обслуживания.html) - пошаговая инструкция по настройке обслуживания от самого простого, до сложного и специфического.
* [Обслуживание баз данных. Не так просто, как кажется](https://ypermitin.github.io/sqlserver/2019/10/14/Обслуживание-баз-данных.-Не-так-просто,-как-кажется.html) - пример ситуации, когда обычное обслуживание баз данных не работает эффективно.
* [UPDATE STATISTICS (Transact-SQL)](https://docs.microsoft.com/ru-ru/sql/t-sql/statements/update-statistics-transact-sql?view=sql-server-ver15) - информация о командах обновления статистики.
* [ALTER INDEX (rebuild, reorganize etc)](https://docs.microsoft.com/ru-ru/sql/t-sql/statements/alter-index-transact-sql?view=sql-server-ver15) - информация о командах изменения индексов.
* [NORECOMPUTE option of UPDATE STATISTICS in SQL Server](https://www.mssqltips.com/sqlservertip/1056/norecompute-option-of-update-statistics-in-sql-server/) - полезная информация об опции NORECOMPUTE.
* [sp_updatestats overview and usage](https://www.sqlshack.com/sp_updatestats-overview-and-usage/) - информация о хранимой процедуре sp_updatestats, поставляемой по умолчанию с СУБД.
* [UPDATE STATISTICS: the Secret IO Explosion](https://www.brentozar.com/archive/2014/01/update-statistics-the-secret-io-explosion/) - почему обновление статистики может привести к проблемам с операциями ввода-вывода.
* [SQL Server Index and Statistics Maintenance](https://ola.hallengren.com/sql-server-index-and-statistics-maintenance.html) - пример решения для обслуживания индексов и статистик.
* [SQL Server 2017 Resumable Online Index Rebuilds](https://www.mssqltips.com/sqlservertip/4987/sql-server-2017-resumable-online-index-rebuilds/) - операции возобновляемого перестроения индексов.
