# Особенности работы с AlwaysOn

Описание некоторых особенностей при работе с группами доступности AlwaysOn.

## Обслуживание индексов и статистик

Запускать обслуживание индексов и статистик необходимо только на основной реплике, на которой доступно изменение данных. Все изменения применятся и для остальных реплик.

Могут быть такие проблемы:
    
    - Статистика на дополнительных репликах не соответствует тем запросам, которые там выполняются, т.к. она формируется на основной реплике. Подробнее [здесь](https://blog.dbi-services.com/sql-server-alwayson-availability-groups-and-statistic-issues-on-secondaries/).
    - Влияние обслуживания индексов на дополнительные реплики. Подробнее [здесь](https://blog.dbi-services.com/sql-server-alwayson-readable-secondary-replicas-and-index-rebuild-online-vs-offline/).

## Настройка прав доступа

Может быть ситуация, что пользователь базы данных один на обоих репликах, а логин на разных инстансах разный, хотя имя у него одно и то же. В этом случае, связать логин SQL Server с существующим пользователям реплики не удастся, т.к. база в режиме только для чтения.

Решение - создать логин на инстансе SQL Server со второй репликой, указав ему тот же самый SID.

Подробнее [здесь](https://blog.sqltreeo.com/create-login-availability-group/).

## Особенности для 1С:Предприятия 8.x

### Суть проблемы

Платформа 1С:Предприятие 8.x не очень хорошо работает с базами данных, которые доступны только для чтения. То есть, если необходимо использовать дополнительные AlwaysOn реплики отдельно от основной, то можно столкнуться с различными проблемами.

Например, у нас есть дополнительная реплика, доступная только для чтения. Для нее в кластере серверов 1С добавлена информационная база. При попытке запуска клиентского приложения чаще всего можно получить подобную ошибку:

```
> Невосстановимая ошибка
> Ошибка при выполнении запроса POST к ресурсу /e1cib/modules/call:
> по причине:
> Соединение с сервером баз данных непригодно для использования после разрыва соединения администратором и будет переустановлено.
> Microsoft SQL Server Native Client 11.0: Failed to update database "YourDatabaseName" because the database is read-only.
> HRESULT=80004005, SQLSrvr: SQLSTATE=25000, state=2, Severity=10, native=3906, line=1
```

Причина проста - платформа пытается изменить данные в базе, а это запрещено на уровне СУБД. При запуске в управляемом приложении ошибка возникает из-за попытки вставки записи в служебную таблицу "_SystemSettings":

```sql
INSERT INTO dbo._SystemSettings (
    _UserId,
    _ObjectKey,
    _SettingsKey,
    _Version,
    _SettingsPresentation,
    _SettingsData,
    _DataSeparationUse16249,
    _DataSeparationUse16250,
    _Fld2293,
    _Fld774) 
VALUES(@P1,@P2,@P3,@P4,@P5,@P6,@P7,@P8,@P9,@P10) 
```

В ней хранятся различные настройки форм, размера окон и многое другое. При работе в управляемом приложении платформа настойчиво пытается сохранить туда данные.

### Вернемся к обычному приложению

Самый простой способ использовать реплику базы данных в режиме только для чтения - это использовать обычное приложение. Конечно, оно считается устаревшим и большинство решений на платформе 1С уже переведены в управляемый интерфейс, но иного простого пути нет.

В обычном приложении платформа не пытается при каждом "чихе" сохранить настройки в базу данных, поэтому способ довольно таки рабочий. Но просто взять и запустить конфигурацию в обычном приложении недостаточно, нужны подготовительные действия:

    1. Отключить защиту от опасных действий на клиентской машине, т.к. предупреждения могут генерировать запись в базу данных, что приведет к ошибке.
    2. В модуле обычного приложения необходимо отказаться от любых операций записи в базу.
        - Для типовых конфигураций на базе БСП нужно отказаться от вызова событий стандартных подсистем. Например, сделать проверку на параметр запуска или другую настройки пользователя.
    3. Проверить модуль сеанса, чтобы там также не было операций модификации данных в базе.
    4. Во всех алгоритмах, предназначенных для работы в базе, нужно избегать явных и неявных запросов на изменение данных.

Конечно, этот вариант может быть не совсем удобным для пользователей из-за непривычного интерфейса, а также для разработчиков из-за дополнительных трудозатрат на поддержку функционала в обычных формах.

### Иные способы

Альтернативный способ - это подключаться к базе данных одним из способов:
    
    - Веб-сервисы
    - HTTP-сервисы
    - COM-соединение

Самое главное - это реализовать функционал в самой конфигурации, чтобы через перечисленные выше способы подключения можно было генерировать отчеты или делать еще какие-либо действия.