# Настройка группы доступности AlwaysOn

Рассмотрим простой пример настройки групп доступности AlwaysOn для базы данных. На каждом этапе будет описание настроек и ссылки на дополнительную информацию.

## Перед настройкой

Для примера будем использовать простую базу данных "TestAG", скрипт для создания которой будет выглядеть следующим образом:

```sql
USE [master]
GO
CREATE DATABASE [TestAG]
 CONTAINMENT = NONE
 ON  PRIMARY 
( 
	NAME = N'TestAG', 
	FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\TestAG.mdf' , 
	SIZE = 8192KB , 
	MAXSIZE = UNLIMITED, 
	FILEGROWTH = 65536KB )
 LOG ON 
( 
	NAME = N'TestAG_log', 
	FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\TestAG_log.ldf' , 
	SIZE = 8192KB , 
	MAXSIZE = 2048GB , 
	FILEGROWTH = 65536KB )
GO

CREATE TABLE [dbo].[SomeObjects](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Name] [nvarchar](150) NOT NULL,
	[Description] [nvarchar](max) NULL,
 CONSTRAINT [PK_SomeObjects] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (
	PAD_INDEX = OFF, 
	STATISTICS_NORECOMPUTE = OFF, 
	IGNORE_DUP_KEY = OFF, 
	ALLOW_ROW_LOCKS = ON, 
	ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

USE [master]
GO
ALTER DATABASE [TestAG] SET READ_WRITE 
GO

```

Для использования AlwaysOn у базы должна стоять модель восстановления "Полная" (Full). Изначально база создана на сервере "SQL-AG-1". Далее создадим группу доступности и реплицируем базу на вторую ноду "SQL-AG-2".

## Создание группы доступности

Пройдемся по основным шагам создания и настройки группы доступности AlwaysOn. Все действия будем выполнять через "Мастер создания групп доступности", который находится в состаке ["SQL Server Management Studio"](https://docs.microsoft.com/ru-ru/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017).

### Начало

Для начала запустим сам мастер, который находится в разделе "Высокий уровень доступности AlwaysOn".

![Запуск мастера создания групп доступности AlwaysOn](media/Создание%20группы%20доступности/1.%20Запуск%20мастера%20создания%20группы%20доступности%20AlwaysOn.PNG)

После увидим начальную информацию об этом инструменте настройки.

![При начале работы с мастером создания групп доступности AlwaysOn](media/Создание%20группы%20доступности/2.%20Начало%20работы%20мастера.PNG)

На следующих этапах начинается непосредственно настройка.

### Параметры группы доступности

На этом этапе необходимо указать имя группы AlwaysOn, а также задать некоторые дополнительные параметры. Имя группы по факту является ее идентификатором и должно соответствовать требованиям идентификаторов для SQL Server.

![Параметры группы доступности](media/Создание%20группы%20доступности/3.%20Параметры%20группы%20доступности.PNG)

**Тип кластера** в нашем случае остается без изменений - "Отказоустойчивый кластер Windows Server", т.к. именно на базе WSFC базируется этот пример. Также этот параметр может принимать такие значения:
    * Внешний - если группа доступности находится под управлением внешних кластеров.
    * Нет - если кластер не используется.

**Определение уровня работоспособности уровня базы данных** - включает определение уровня работоспособности базы, но в нашем случае это излишне, также как и использование DTC.

Более подробную информацию о настройках на этом этапе [смотреть здесь](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/specify-availability-group-name-page?view=sql-server-2017).

### Выбор базы данных

На этапом этапе нужно выбрать базу, которая будет входить в создаваемую группу.

![Выбор базы для группы](media/Создание%20группы%20доступности/4.%20Выбор%20базы%20данных.PNG)

Для каждой базы предварительно выполняются проверки соответствия требования для включения в группу доступности. Например:
    * Не входил ли эта база уже в одну из групп
    * Используется ли полная модель восстановления
    * Нужно ли выполнить полный бэкап
    * И др.

Более подробную информацию о настройках на этом этапе [смотреть здесь](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/select-databases-page-new-availability-group-wizard-and-add-database-wizard?view=sql-server-2017).

### Указание реплик

На этом этапе нужно настроить состав инстансов SQL Server, на которых будут располагаться реплики базы данных, а также другие связанные с ними настройки.

На вкладке "Реплики" добавим вторую ноду. В итоге настройка будет выглядеть следующим образом.

![Добавление реплик](media/Создание%20группы%20доступности/5.%20Указание%20реплик.PNG)

В группу будут входить первичная реплика (SQL-AG-1) и вторичная (SQL-AG-2). Для каждой установлен режим доступности "Асинхронная фиксация". Вообще есть два режима фиксации:
    
    * Синхронная - это значит, что транзакции в базе данных будут одновременно фиксировать на тех репликах, для которых установлен этот режим доступности. Максимум в группе доступности может быть установлено 3 таких реплики. Используется для повышения уровня отказоустойчивости, т.к. позволяет выполнять автоматический переход с одной реплики на другую практически мгновенно. Единственный минус - это возможное падение производительности, т.к. производительность будет равна производительности самой медленной синхронной реплики. Плюс ко всему появиться накладные расходы на фиксацию транзакций во всех синхронных репликах.
    * Асинхронная - фиксация транзакций выполняется в первичной реплике, а во вторичные реплики изменения передаются асинхронно с некоторой задержкой. Благодаря этому производительность не снижается, но автоматический переход на вторичную ноду невозможен, т.к. есть вероятность рассинхронизации данных между узлами.

Для нашего примера выберем асинхронный режим доступности, т.к. отказоустойчивость нам сейчас ни к чему.

Параметр "Вторичная реплика для чтения" может принимать три значения:

    * Нет - прямые подключения к реплике не разрешаются.
    * Да - разрешены все соединения с доступом на чтение, в том числе и старым клиентам.
    * Назначение — только чтение - разрешены только прямые подключения для чтения.

Чтобы иметь возможность работы с репликами, например, из SSMS - установим значение "Да".

На вкладке "Конечные точки" мы ничего не изменяем, нас устраивают настройки по умолчанию. Конечные точки (Endpoints) используются для зеркалирования и настраиваются на уровне инстансов SQL Server. Посмотреть их можно через "Объекты сервера -> Конечные точки -> Зеркальное отображение".

![Настройки конечных точке](media/Создание%20группы%20доступности/6.%20Конечные%20точки%20реплик%20для%20подключения.PNG)

Вкладка "Параметры резервного копирования" говорит сама за себя. В нашем случае тему бэкапов мы не рассматриваем, поэтому параметры не меняем. Фактически эти настройки определяют какие реплики будут использоваться для формирования бэкапа.

![Параметры резервного копирования](media/Создание%20группы%20доступности/7.%20Параметры%20резервного%20копирования%20реплик.PNG)

Вкладка "Прослушиватель" используется для настройки прослушивателя группы доступности.

![Прослушиватель группы AlwaysOn](media/Создание%20группы%20доступности/8.%20Настройка%20прослушивателя.PNG)

Прослушиватель позволяет подключаться к группе доступности AlwaysOn, при этом не зная имени физического экземпляра SQL Server. Также с его помощью достигается быстрое переключение между синхронными репликами в случае аварий. Для примера на вкладке выполнены настройки адреса и DNS-имени, но в нашем случае они особого значения не имеют.

На последней вкладке "Маршрутизация" выполняются настройки подключения только для чтений по каждой реплик. В примере это рассматривать не будем.

![Маршрутизация реплик](media/Создание%20группы%20доступности/9.%20Маршрутизация%20реплик.PNG)

Более подробную информация о настройках на этапе "Указание реплик" [смотреть здесь](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/specify-replicas-page-new-availability-group-wizard-add-replica-wizard?view=sql-server-2017).

### Выбор синхронизации данных

Теперь необходимо выбрать как база с первичной реплики будет доставлена на вторичные узлы.

![Выбор начальной синхронизации данных](media/Создание%20группы%20доступности/10.%20Выбор%20параметров%20начальной%20синхронизации.PNG)

Самый простой способ - использовать **"Автоматическое заполнение"**, но в этом случае пути к файлам с данными и журналам транзакций на серверах совпадали. Также этот вариант может не подойти для очень больших баз данных. Для простоты в нашем примере мы выберем именно этот способ.

Другие варианты синхронизации:

    * Полная архивация базы данных и журналов - в этом случае будет выполнено полное резервное копирование базы и резервное копирование лога транзакций в общую папку для узлов. Далее бэкапы будут использованы для развертывания базы на вторичной реплике.
    * Только присоединение - используется, только если на новых вторичных репликах база данных уже создана и настроена.
    * Пропустить начальную синхронизацию данных - используется, если все действия по разворачиванию базы на второй реплике выполняются вручную.

Более подробную информация о настройках на этапе "Выбор синхронизации данных" [смотреть здесь](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards?view=sql-server-2017).

### Проверка, сводка, результат

Далее выполняется предварительная проверка конфигурации узлов.

![Проверка группы доступности](media/Создание%20группы%20доступности/11.%20Результат%20провервки%20конфигурации.PNG)

Если все в порядке, то будет доступна сводка по всем установленным параметрам. На этом этапе нужно подтвердить, что все корректно настроено и можно применять настройки.

![Сводка по настройкам группы доступности](media/Создание%20группы%20доступности/12.%20Сводка%20по%20установленным%20параметрам%20и%20подтверждение%20перед%20применением%20настроек.PNG)

Также на этом этапе можно получить SQL-скрипт, который выполнить все сделанные настройки (см. команду "Скрипт" в правом нижнем углу). Запускать его следует через [SQLCMD](https://docs.microsoft.com/ru-ru/sql/tools/sqlcmd-utility?view=sql-server-2017).

Ждем применения изменений.

![Процесс создания группы доступности](media/Создание%20группы%20доступности/13.%20Процесс%20применения%20настроек%20группы%20доступности%20AlwaysOn.PNG)

И все готово!

![Группа доступности создана](media/Создание%20группы%20доступности/14.%20Группа%20доступности%20успешно%20создана.PNG)

## Проверка работоспособности

Проверить, что мы все сделали правильно можно двумя способами.

### Панель мониторинга AlwaysOn

[Панель мониторинга AlwaysOn](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/options-sql-server-always-on-dashboard-page?view=sql-server-2017) позволяет проверить текущее состояние группы доступности.

![Открытие панели мониторинга AlwaysOn](media/Открытие%20панели%20мониторинга.PNG)

Открыть панель мониторинга можно на любой реплике. Сама панель может выглядеть так, но все зависит от текущего состояния группы.

![Панель мониторинга AlwaysOn](media/Панель%20мониторинга%20AlwaysOn.PNG)

При расследовании инцидентов этот инструмент не всегда поможет, но позволяет найти / подтвердить наличие проблем как минимум.

### Проверим передачу изменений

Другой способ - добавить в таблицу "" нашей тестовой базы запись на узле "SQL-AG-1".

```sql
-- Добавляем запись на первой реплике
INSERT [TestAG].[dbo].[SomeObjects] ([Name], [Description])
	VALUES('Проверка', 'Проверка группы доступности AlwaysOn');
```

А после проверяем содержимое на второй реплике.

```sql
SELECT TOP (1000) [ID]
      ,[Name]
      ,[Description]
  FROM [TestAG].[dbo].[SomeObjects]
```

Если новая запись есть во всех репликах, то группа доступности работает как надо!

## При ручном восстановлении базы

В случаях, когда база данных на вторичной реплике была восстановлена вручную в режие "NORECOVERY", ее можно включить в группу доступности AlwaysOn вручную командой:

```sql
ALTER DATABASE [DatabaseName] SET HADR AVAILABILITY GROUP = [AlwaysOnGroupName];  
```

Главное перед этим на базу данных также восстановить последние файлы лога транзакций.

## Полезные ссылки

* [Администрирование группы доступности](https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/administration-of-an-availability-group-sql-server?view=sql-server-2017)
* [MS SQL Server AlwaysOn. Шаг за Шагом](http://sqlcom.ru/dba-tools/ms-sql-server-alwayson-step-by-step/)
* [Группы доступности AlwaysOn и задания SQL Server](https://www.osp.ru/winitpro/2014/11/13043634/)
* [SQL Server 2012 AlwaysOn](https://www.red-gate.com/simple-talk/sql/database-administration/sql-server-2012-alwayson/)
